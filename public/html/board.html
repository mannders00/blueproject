<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BlueProject</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <style>
    #map {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: -1;
    }
  </style>
</head>

<body>

  <main>

    {{ template "header.tmpl" }}

    <div class="container-fluid" style="pointer-events: none;">

      <div class="row">
        <div class="col-md-4" style="pointer-events: all;">
          <div class="collapse show" id="collapseFilters">

            <div class="accordion p-4">
              <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header" id="panelsStayOpen">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse"
                    data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true"
                    aria-controls="panelsStayOpen-collapseOne">
                    Search and Filter
                  </button>
                </h2>
                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show"
                  aria-labelledby="panelsStayOpen">
                  <div class="accordion-body p-0 mt-4">

                    <div class="card">
                      <div class="card-body">

                        <form method="get">
                          <div class="form-group">
                            <div class="mb-3">
                              <label for="location" class="form-label">Location</label>
                              <input type="text" class="form-control" id="formInputLocation"
                                placeholder="Zip code or address">
                            </div>
                            <div class="col">
                              <div class="mb-3">
                                <label for="location" class="form-label">Project</label>
                                <select class="form-select" aria-label="Default select example">
                                  <option selected value="ev-charger">EV Charger</option>
                                  <option value="solar">Solar Panel</option>
                                  <option value="battery">Home Battery</option>
                                </select>
                              </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                          </div>
                        </form>
                      </div>
                    </div>


                    <div id="card-list" class="p-0 m-0">

                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col" style="pointer-events: none;">
        </div>
      </div>

    </div>

    <div id="map" style="pointer-events: all;"></div>

  </main>

  <script>
    var markers = [
      { id: 1, name: 'Company 1', description: 'This is the very long description of company 1', lng: -87.623177, lat: 41.881832 },
      { id: 2, name: 'Company 2', description: 'This is the very long description of company 2', lng: -87.633177, lat: 41.891832 },
      { id: 3, name: 'Company 3', description: 'This is the very long description of company 3', lng: -87.643177, lat: 41.901832 },
      { id: 4, name: 'Company 4', description: 'This is the very long description of company 4', lng: -87.653177, lat: 41.911832 },
      { id: 5, name: 'Company 5', description: 'This is the very long description of company 5', lng: -87.663177, lat: 41.921832 },
      { id: 6, name: 'Company 6', description: 'This is the very long description of company 6', lng: -87.673177, lat: 41.931832 },
      { id: 7, name: 'Company 7', description: 'This is the very long description of company 7', lng: -87.683177, lat: 41.941832 },
      { id: 8, name: 'Company 8', description: 'This is the very long description of company 8', lng: -87.693177, lat: 41.951832 },
      { id: 9, name: 'Company 9', description: 'This is the very long description of company 9', lng: -87.703177, lat: 41.961832 },
      { id: 10, name: 'Company 10', description: 'This is the very long description of company 10', lng: -87.713177, lat: 41.971832 },
      { id: 11, name: 'Company 11', description: 'This is the very long description of company 11', lng: -87.723177, lat: 41.981832 },
      { id: 12, name: 'Company 12', description: 'This is the very long description of company 12', lng: -87.733177, lat: 41.991832 },
      { id: 13, name: 'Company 13', description: 'This is the very long description of company 13', lng: -87.743177, lat: 41.1001832 },
      { id: 14, name: 'Company 14', description: 'This is the very long description of company 14', lng: -87.753177, lat: 41.1011832 },
    ];

    const cardList = document.getElementById("card-list")

    mapboxgl.accessToken = 'pk.eyJ1IjoibWF0dGE5MDAxIiwiYSI6ImNsZWcweHk1ajAyM3Y0M3BobTJ5anQyMjEifQ.fxWRoGxTSyz1T1vw0I3R8w';
    const map = new mapboxgl.Map({
      container: 'map', // container ID
      style: 'mapbox://styles/mapbox/streets-v12', // style URL
      center: [-87.623177, 41.881832],
      zoom: 9 // starting zoom
    });

    function createMarker(markerData) {

      var popUp = new mapboxgl.Popup({ offset: 25 }).setHTML("<h3>" + markerData.name + "</h3><p>" + markerData.description + "</p>");

      // Create marker object
      var marker = new mapboxgl.Marker()
        .setLngLat([markerData.lng, markerData.lat])
        .setPopup(popUp)
        .addTo(map);

      // Create Bootstrap card with javascript directly
      const card = document.createElement("div");
      card.classList.add("card");
      card.classList.add("py-4");
      card.classList.add("my-4");

      const cardBody = document.createElement("div");
      cardBody.classList.add("card-body");

      const cardTitle = document.createElement("h5");
      cardTitle.classList.add("card-title");
      cardTitle.textContent = markerData.name;
      cardBody.append(cardTitle);

      const cardText = document.createElement("p");
      cardText.classList.add("card-text");
      cardText.textContent = markerData.description;
      cardBody.append(cardText);

      card.appendChild(cardBody);

      card.id = "list-card-" + markerData.id;
      card.tabIndex = markerData.id;

      card.onclick = function () {
        map.flyTo({ center: marker.getLngLat(), zoom: 15 });
        scrollToCard(markerData);
      }

      cardList.appendChild(card);

      marker.getElement().addEventListener('click', function () {
        map.flyTo({ center: marker.getLngLat(), zoom: 15 });
        scrollToCard(markerData);
      });
    }

    function scrollToCard(markerData) {
      const myCollapsibleDiv = document.getElementById("collapseFilters");
      myCollapsibleDiv.classList.add("show");

      const cardFocus = document.getElementById("list-card-" + markerData.id);

      // Calculate the center position of the screen
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;

      // Calculate the position of the div relative to the screen
      const rect = cardFocus.getBoundingClientRect();
      const divX = rect.x + rect.width / 2;
      const divY = rect.y + rect.height / 2;

      // Calculate the scroll offset needed to center the div
      const scrollX = divX - centerX;
      const scrollY = divY - centerY;

      // Apply the scroll offset to the window
      window.scrollBy({ left: scrollX, top: scrollY, behavior: "smooth" });

      highlightCard(markerData);
    }

    function highlightCard(markerData) {
      var items = cardList.querySelectorAll('div');

      items.forEach(function (item) {
        item.classList.remove('shadow');
        item.classList.remove('text-bg-primary');
      });

      items.forEach(function (item) {
        if (item.id == 'list-card-' + markerData.id) {
          item.classList.add('shadow');
          item.classList.add('text-bg-primary');
        }
      });
    }

    markers.forEach(function (markerData) {
      createMarker(markerData);
    });

  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</body>

</html>